<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.metamong.mt.domain.admin.repository.mybatis.AdminMapper">

    <select id="searchMembers" resultType="com.metamong.mt.domain.admin.dto.response.MemberSearchResponseDto">
    <![CDATA[
        SELECT 
    m.email, 
    case when m.role ='ROLE_PROV' then '시설제공자' 
        when m.role ='ROLE_CONS' then '시설이용자'
    end as role,
    CASE 
        WHEN m.mem_banned_until IS NULL THEN '정상' 
        ELSE '정지' 
    END AS accountStatus, 
    COUNT(r.rvt_id) AS reservationCount, 
    m.created_at as createdAt
FROM 
    member m
LEFT JOIN 
    reservation r ON m.mem_id = r.cons_id
GROUP BY  
    m.email, 
    m.role, 
    m.mem_banned_until,  
    m.created_at
ORDER BY m.created_at
    ]]>
	</select>


    <!-- 신고된 회원 목록 조회 -->
    <select id="getReportedMembers" resultType="com.metamong.mt.domain.admin.dto.response.ReportedMemberResponseDto">
        SELECT m.email, r.report_type, r.report_msg
        FROM member m
        JOIN report r ON m.mem_id = r.reported_id
        GROUP BY m.email, r.report_type, r.report_msg
    </select>

    <!-- 신고된 아이디 정지 기간 업데이트 (배치 처리) -->
<update id="updateMemberBan" parameterType="map">
    <![CDATA[
    <foreach collection="list" item="reportData" separator=";">
        UPDATE member
        SET mem_banned_until = 
            CASE 
                WHEN #{reportData.reportCount, jdbcType=INTEGER} = 1 THEN SYSDATE + INTERVAL '7' DAY
                WHEN #{reportData.reportCount, jdbcType=INTEGER} = 2 THEN SYSDATE + INTERVAL '14' DAY
                WHEN #{reportData.reportCount, jdbcType=INTEGER} >= 3 THEN TO_DATE('2999-12-31', 'YYYY-MM-DD')
            END
        WHERE mem_id = #{reportData.reportedId, jdbcType=BIGINT}
    </foreach>
    ]]>
</update>




<delete id="deleteReportedData" parameterType="list">
    <![CDATA[
    <foreach collection="list" item="reportedId" separator=";">
        DELETE FROM report
        WHERE reported_id = #{reportedId}
    </foreach>
    ]]>
</delete>


    <!-- 신고 횟수 조회 -->
	<resultMap id="reportCountMap" type="java.util.HashMap">
	    <result property="reported_id" column="reported_id"/>
	    <result property="report_count" column="report_count" jdbcType="DECIMAL" javaType="java.lang.Integer"/>
	</resultMap>

<select id="getReportCounts" resultMap="reportCountMap">
    SELECT reported_id as reportedId , COUNT(*) AS reportCount
    FROM report
    GROUP BY reported_id
</select>

<select id="getRequestFacilities" resultType="com.metamong.mt.domain.admin.dto.response.ApprovalRequestDto">
SELECT 
fct_id,
    fct_name, 
    ('(' || fct_postal_code || ') ' || fct_address || ' ' || fct_detail_address) AS full_address,
    fct_tel, 
    is_open_on_holidays,
    CASE 
        WHEN fct_state = 'REG_REQUESTED' THEN '등록요청' 
        WHEN fct_state = 'DEL_REQUESTED' THEN '삭제요청' 
    END AS fct_state 
FROM facility
WHERE fct_state IN ('REG_REQUESTED', 'DEL_REQUESTED')

    </select>

 <!-- 등록 요청 승인 쿼리 -->
    <update id="updateFacilityStateRegApproved" parameterType="map">
        UPDATE facility
        SET fct_state = 'REGISTERED'
        WHERE fct_state = 'REG_REQUESTED'
        AND fct_id = #{fctId}
    </update>

     <!-- 등록 요청 반려 쿼리 -->
    <update id="updateFacilityStateRegRejected" parameterType="map">
        UPDATE facility
        SET fct_state = 'DELETED'
        WHERE fct_state = 'REG_REQUESTED'
        AND fct_id = #{fctId}
    </update>

     <!-- 삭제 요청 승인 쿼리 -->
    <update id="updateFacilityStateDelApproved" parameterType="map">
        UPDATE facility
        SET fct_state = 'DEL_APPROVED'
        WHERE fct_state = 'DEL_REQUESTED'
        AND fct_id = #{fctId}
    </update>

    <!-- 삭제 요청 반려 쿼리 -->
    <update id="updateFacilityStateDelRejected" parameterType="map">
        UPDATE facility
        SET fct_state = 'DEL_REJECTED'
        WHERE fct_state = 'DEL_REQUESTED'
        AND fct_id = #{fctId}
    </update>

    <!-- 알림 테이블에 데이터 추가 쿼리 -->
<insert id="insertNotification" parameterType="map">
    INSERT INTO notification (receiver_id, noti_msg, is_read, created_at)
    VALUES (#{receiverId}, #{notiMsg}, 'N', CURRENT_TIMESTAMP)
</insert>


    <select id="searchFacilities" resultType="com.metamong.mt.domain.admin.dto.response.FacilitySearchResponseDto">
     SELECT 
     fct_id,
    fct_name, 
    zone_name,
    (select COUNT(rvt_id)from reservation where rvt_cancelation_reason IS NULL) as rvt_cnt,
    (select COUNT(rvt_id)from reservation where rvt_cancelation_reason IS not NULL) as rvt_cancel_cnt,
    cons_id
    FROM 
    reservation r join zone z on r.zone_id = z.zone_id
    join facility f on z.fct_id = f.fct_id
     group by fct_name, zone_name,cons_id
    </select>
    
    <!-- 시설명, zone명, 결제일, 결제금액, 결제방법 -->
    <select id="getPaymentDetails" resultType="com.metamong.mt.domain.admin.dto.response.SalesExportDto">
        SELECT 
            z.fct_id, 
            z.zone_id, 
            p.pay_date, 
            p.pay_price, 
            p.pay_method 
        FROM 
            payment p
        JOIN 
            reservation r ON p.rvt_id = r.cons_id
        JOIN 
            zone z ON z.zone_id = r.zone_id
    </select>

    <!-- 총금액 -->
    <select id="getTotalRevenue" resultType="java.math.BigDecimal">
        SELECT 
            NVL(SUM(p.pay_price), 0) AS total_revenue
        FROM 
            payment p
        JOIN 
            reservation r ON p.rvt_id = r.cons_id
        JOIN 
            zone z ON z.zone_id = r.zone_id
    </select>

<select id="getReservationsThisWeek" resultType="com.metamong.mt.domain.admin.dto.response.WeekReservationDto">
<![CDATA[
        SELECT z.fct_id,
            SUM(CASE WHEN TO_CHAR(r.rvt_date, 'D') = 1 THEN 1 ELSE 0 END) AS "Sun",
            SUM(CASE WHEN TO_CHAR(r.rvt_date, 'D') = 2 THEN 1 ELSE 0 END) AS "Mon",
            SUM(CASE WHEN TO_CHAR(r.rvt_date, 'D') = 3 THEN 1 ELSE 0 END) AS "Tues",
            SUM(CASE WHEN TO_CHAR(r.rvt_date, 'D') = 4 THEN 1 ELSE 0 END) AS "Wednes",
            SUM(CASE WHEN TO_CHAR(r.rvt_date, 'D') = 5 THEN 1 ELSE 0 END) AS "Thurs",
            SUM(CASE WHEN TO_CHAR(r.rvt_date, 'D') = 6 THEN 1 ELSE 0 END) AS "Fri",
            SUM(CASE WHEN TO_CHAR(r.rvt_date, 'D') = 7 THEN 1 ELSE 0 END) AS "Satur"
        FROM
            reservation r
        JOIN
            zone z ON r.zone_id = z.zone_id
        WHERE
            r.rvt_date >= TRUNC(SYSDATE, 'WW')
            AND r.rvt_date < TRUNC(SYSDATE, 'WW') + 7
        GROUP BY
            z.fct_id
]]>
</select>

<select id="getTotalReservations" resultType="com.metamong.mt.domain.admin.dto.response.FacilityReservationResponseDto">
        SELECT f.fct_name, COUNT(r.rvt_id) AS total_reservations, f.fct_id
        FROM facility f
        JOIN zone z ON f.fct_id = z.fct_id
        JOIN reservation r ON r.zone_id = z.zone_id
        WHERE r.rvt_cancelation_reason IS NULL
        GROUP BY f.fct_name, f.fct_id
    </select>

    <!-- 취소된 예약 건수 -->
    <select id="getCancelledReservations" resultType="com.metamong.mt.domain.admin.dto.response.FacilityReservationResponseDto">
        SELECT f.fct_name, COUNT(r.rvt_id) AS cancelled_reservations, f.fct_id
        FROM facility f
        JOIN zone z ON f.fct_id = z.fct_id
        JOIN reservation r ON r.zone_id = z.zone_id
        WHERE r.rvt_cancelation_reason IS NOT NULL
        GROUP BY f.fct_name, f.fct_id
    </select>

    <!-- 매출 -->
    <select id="getTotalByFacility" resultType="com.metamong.mt.domain.admin.dto.response.FacilityReservationResponseDto">
      SELECT f.fct_name, SUM(pay_price) AS total_revenue, f.fct_id
        FROM facility f
        JOIN zone z ON f.fct_id = z.fct_id
        JOIN reservation r ON r.zone_id = z.zone_id
        join payment p on r.rvt_id = p.rvt_id
        WHERE r.rvt_cancelation_reason IS NULL
        GROUP BY f.fct_name, f.fct_id
    </select>

</mapper>